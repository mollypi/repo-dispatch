name: Release new CLI versions
on:
  push:
    tags:
      - '*'

env:
 TAG_URL: https://api.github.com/repos/mollypi/repo-dispatch/tags
 RELEASE_URL: https://api.github.com/repos/mollypi/repo-dispatch/releases

jobs:
  release-new-cli:
    name: Release new CLI versions
    runs-on: ubuntu-latest

    permissions:
      contents: 'write'
      id-token: 'write'

    steps:
      - uses: actions/checkout@v3
      

      - name: get latest tag
        run: |- 
          TAG=$(curl --silent  "${{env.TAG_URL}}" | \
           jq --raw-output '.[0].name')
          echo "LAST_TAG=${TAG}" >> $GITHUB_ENV

      - name: debug
        run: echo $env.LAST_TAG

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ env.LAST_TAG }}
          release_name: CLI Release ${{ env.LAST_TAG }}
          draft: false
          prerelease: false

      - name: create version file 
        run: |
          touch version
          echo $env.LAST_TAG >> version

          cat version
      
      - name: create notes file 
        run: |
          touch notes.txt
          NOTES=$(curl --silent  "${{env.RELEASE_URL}}" | \
           jq --raw-output '.[0].body')
          echo "${NOTES}" >> notes.txt

          cat notes.txt





      - uses: robinraju/release-downloader@v1.4
        with:
          latest: true
          tarBall: true
          zipBall: true